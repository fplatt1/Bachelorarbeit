import numpy as np
from scipy.optimize import curve_fit
import matplotlib.pyplot as plt

# --- 1. Definition der Modellfunktion (Lorentz-Kurve) ---
def lorentzian(x, amplitude, center, width, offset):
    """
    Definiert eine Lorentz-Funktion.
    'width' ist hier die Halbwertsbreite bei halbem Maximum (HWHM).
    Die FWHM ist 2 * width.
    """
    return offset + (amplitude * (width**2 / ((x - center)**2 + width**2)))


# --- 2. Dateipfad und Parameter ---
# Gib hier den Pfad zu der Datei an, die du analysieren möchtest
DATEIPFAD = r"H:\Meine Ablage\Uni\Bachelorarbeit\Code Dateien\P4_Cluster_2_mittleres_Spektrum.txt" 

# Definiere das Fenster, in dem der 2D-Peak gesucht wird
PEAK_FENSTER = (2600, 2800)


# --- 3. Daten laden und Peak isolieren ---
print(f"Lade Daten aus: {DATEIPFAD}")
data = np.loadtxt(DATEIPFAD)
x_data, y_data = data[:, 0], data[:, 1]

# Schneide nur den Bereich des 2D-Peaks aus
mask = (x_data >= PEAK_FENSTER[0]) & (x_data <= PEAK_FENSTER[1])
x_peak = x_data[mask]
y_peak = y_data[mask]


# --- 4. Startwerte für den Fit schätzen ---
offset_guess = np.min(y_peak)
amplitude_guess = np.max(y_peak) - offset_guess
center_guess = x_peak[np.argmax(y_peak)]
width_guess = 20  # Ein typischer Startwert

initial_guesses = [amplitude_guess, center_guess, width_guess, offset_guess]


# --- 5. Curve Fitting durchführen ---
try:
    params, covariance = curve_fit(lorentzian, x_peak, y_peak, p0=initial_guesses)
    
    # Extrahiere die optimierten Parameter
    fit_amplitude, fit_center, fit_width, fit_offset = params
    
    # Berechne die FWHM (Full Width at Half Maximum)
    fwhm = 2 * fit_width
    
    print("\n--- Fit-Ergebnisse ---")
    print(f"  Peak-Position: {fit_center:.2f} cm-1")
    print(f"  FWHM: {fwhm:.2f} cm-1")
    print("----------------------")

    # --- 6. Ergebnis visualisieren ---
    plt.figure(figsize=(10, 6))
    plt.plot(x_peak, y_peak, 'bo', label='Messdaten', markersize=3)
    plt.plot(x_peak, lorentzian(x_peak, *params), 'r-', label='Lorentz-Fit')
    plt.title(f'2D-Peak Fit für {DATEIPFAD}')
    plt.xlabel('Raman shift (cm⁻¹)')
    plt.ylabel('Intensity (a.u.)')
    plt.legend()
    plt.grid(True)
    plt.show()

except RuntimeError:
    print("\nFEHLER: Der Fit konnte keine Lösung finden. Überprüfe die Daten oder die Startwerte.")